<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Laudos de Vistoria</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

</head>
<body>
    <h1>Laudo de Vistoria</h1>
    <p>Use as preferências default, carregue o arquivo com as suas preferências ou edite e salve suas preferências:</p>
    <button id='importarPreferências' onclick="importarPref()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; height: 45px; width: 49%;">Importar Preferências</button>
    <button id='salvarPreferências' onclick="salvarPref()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; height: 45px; width: 49%;">Salvar Preferências</button>

    <textarea id="dadosBase" name="dadosBase" rows="5"></textarea>
    
    <p>Capture uma imagem, abra uma foto ou cole o texto extraído OCR:</p>
    <button id='captFoto' onclick="capturarFoto()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; height: 45px; width: 49%;">Capturar Foto</button>
    <button id='abrirFoto' onclick="abrirFoto()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; height: 45px; width: 49%;">Abrir Foto</button>

    <video id="camera" autoplay></video>
    <canvas id="foto" style="display:none;"></canvas>
    
    <label for="textoOCR">Texto a ser processado:</label>

    <textarea id="textoOCR" name="textoOCR" placeholder="Cole aqui ou aguarde o processamento." rows="5"></textarea>
     
    <button id='analisarTexto' onclick="analisarTexto()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; width: 100%;">Analisar Texto</button>
    
    <textarea id="textoAnalisado" placeholder="Informações processadas." name="textoAnalisado" rows="5"></textarea>

    <button id='novoDano' onclick="abrirPopupDano()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; width: 100%;">Novo Dano</button>

    
    <div id="popupTipoDano" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 10px; border: 1px solid black; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
        <h3>Tipo de Dano</h3>

        <div>
            <input type="checkbox" id="amolgamento"> <label for="amolgamento">Amolgamento(s)</label><br>
            <input type="checkbox" id="atritamento"> <label for="atritamento">Atritamento(s)</label><br>
            <input type="checkbox" id="fratura"> <label for="fratura">Fratura(s)</label><br>
        </div>
        <button onclick="proximoOrientacao()" style="margin-top: 10px;">Próximo</button>
    </div>

    <div id="popupOrientacao" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid black; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
        <h3>Orientação</h3>
        <div>
            <input type="checkbox" id="frenteTras"> <label for="frenteTras">de frente para trás</label><br>
            <input type="checkbox" id="trasFrente"> <label for="trasFrente">de trás para frente</label><br>
            <input type="checkbox" id="dirEsq"> <label for="dirEsq">da direita para a esquerda</label><br>
            <input type="checkbox" id="esqDir"> <label for="esqDir">da esquerda para a direita</label><br>
            <input type="checkbox" id="cimaBaixo"> <label for="cimaBaixo">de cima para baixo</label><br>
            <input type="checkbox" id="baixoCima"> <label for="baixoCima">de baixo para cima</label><br>
        </div>
        <button onclick="proximoSituado()" style="margin-top: 10px;">Próximo</button>
    </div>

    <div id="popupSituado" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid black; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
        <h3>Situado</h3>
        <div>
            <input type="checkbox" id="pa"> <label for="pa">na porção anterior</label><br>
            <input type="checkbox" id="pad"> <label for="pad">na porção anterior direita</label><br>
            <input type="checkbox" id="pae"> <label for="pae">na porção anterior esquerda</label><br>
            <input type="checkbox" id="pp"> <label for="pp">na porção posterior</label><br>
            <input type="checkbox" id="ppd"> <label for="ppd">na porção posterior direita</label><br>
            <input type="checkbox" id="ppe"> <label for="ppd">na porção posterior esquerda</label><br>
            <input type="checkbox" id="fe"> <label for="fe">no flanco esquerdo</label><br>
            <input type="checkbox" id="fea"> <label for="fea">no flanco esquerdo, terço anterior</label><br>
            <input type="checkbox" id="fep"> <label for="fed">no flanco esquerdo, terço posterior</label><br>
            <input type="checkbox" id="fd"> <label for="fd">no flanco direito</label><br>
            <input type="checkbox" id="fda"> <label for="fda">no flanco direito, terço anterior</label><br>
            <input type="checkbox" id="fdp"> <label for="fdp">no flanco direito, terço posterior</label><br>
            <input type="checkbox" id="fdp"> <label for="fdp">na porção inferior</label><br>
            <input type="checkbox" id="fdp"> <label for="fdp">na porção superior</label><br>
        </div>
        <button onclick="finalizarDano()" style="margin-top: 10px;">FIM</button>
    </div>

    <textarea id="danosVeic" placeholder="Danos no veículo" name="danosVeic" rows="5"></textarea>

    <button id='novoTeste' onclick="abrirPopupTeste()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; width: 100%;">Novo Teste</button>

    <div id="popupTeste" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 10px; border: 1px solid black; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
        <h3>Marcar não funcionais</h3>
        <div>
            <input type="checkbox" id="lanternaAnteriorDireita"> <label for="lanternaAnteriorDireita">lanterna anterior direita</label><br>
            <input type="checkbox" id="lanternaAnteriorEsquerda"> <label for="lanternaAnteriorEsquerda">lanterna anterior esquerda</label><br>
            
            <input type="checkbox" id="farolDireito"> <label for="farolDireito">farol direito</label><br>
            <input type="checkbox" id="farolEsquerdo"> <label for="farolEsquerdo">farol esquerdo</label><br>

            <input type="checkbox" id="farolAltoDireito"> <label for="farolAltoDireito">farol alto direito</label><br>
            <input type="checkbox" id="farolAltoEsquerdo"> <label for="farolAltoEsquerdo">farol alto esquerdo</label><br>
            
            <input type="checkbox" id="setaAnteriorDireita"> <label for="setaAnteriorDireita">seta anterior direita</label><br>
            <input type="checkbox" id="setaAnteriorEsquerda"> <label for="setaAnteriorEsquerda">seta anterior esquerda</label><br>

            <input type="checkbox" id="buzina"> <label for="buzina">buzina</label><br>
            
            <input type="checkbox" id="luzRe"> <label for="luzRe">luz de ré</label><br>
            
            <input type="checkbox" id="lanternaPosteriorDireita"> <label for="lanternaPosteriorDireita">lanterna posterior direita</label><br>
            <input type="checkbox" id="lanternaPosteriorEsquerda"> <label for="lanternaPosteriorEsquerda">lanterna posterior esquerda</label><br>

            <input type="checkbox" id="setaPosteriorDireita"> <label for="setaPosteriorDireita">seta posterior direita</label><br>
            <input type="checkbox" id="setaPosteriorEsquerda"> <label for="setaPosteriorEsquerda">seta posterior esquerda</label><br>
            
            <input type="checkbox" id="freio"> <label for="freio">freio</label><br>

            <input type="checkbox" id="pneumaticoAnteriorEsquerdo"> <label for="pneumaticoAnteriorEsquerdo">pneumáticos anterior esquerdo</label><br>
            <input type="checkbox" id="pneumaticoAnteriorDireito"> <label for="pneumaticoAnteriorDireito">pneumáticos anterior direito</label><br>
            <input type="checkbox" id="pneumaticoPosteriorDireito"> <label for="pneumaticoPosteriorDireito">pneumáticos posterior direito</label><br>
            <input type="checkbox" id="pneumaticoPosteriorEsquerdo"> <label for="pneumaticoPosteriorEsquerdo">pneumáticos posterior esquerdo</label><br>

            <input type="checkbox" id="direcao"> <label for="direcao">direção</label><br>
            <input type="checkbox" id="airbags"> <label for="airbags">airbags</label><br>

            <input type="checkbox" id="cintoMotorista"> <label for="cintoMotorista">cinto do motorista</label><br>
            <input type="checkbox" id="cintoPassageiro"> <label for="cintoPassageiro">cinto do passageiro</label><br>
            <input type="checkbox" id="cintoTraseiroEsquerdo"> <label for="cintoTraseiroEsquerdo">cinto traseiro esquerdo</label><br>
            <input type="checkbox" id="cintoTraseiroCentral"> <label for="cintoTraseiroCentral">cinto traseiro central</label><br>
            <input type="checkbox" id="cintoTraseiroDireito"> <label for="cintoTraseiroDireito">cinto traseiro direito</label><br>
        </div>
        <button onclick="proximoAvariados()" style="margin-top: 10px;">Próximo</button>
    </div>

    <div id="popupAvariados" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 10px; border: 1px solid black; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
        <h3>Avariados no acidente</h3>
        <div>
            <input type="checkbox" id="lanternaAnteriorDireitaAv"> <label for="lanternaAnteriorDireitaAv">lanterna anterior direita</label><br>
            <input type="checkbox" id="lanternaAnteriorEsquerdaAv"> <label for="lanternaAnteriorEsquerdaAv">lanterna anterior esquerda</label><br>
            
            <input type="checkbox" id="farolDireitoAv"> <label for="farolDireitoAv">farol direito</label><br>
            <input type="checkbox" id="farolEsquerdoAv"> <label for="farolEsquerdoAv">farol esquerdo</label><br>

            <input type="checkbox" id="farolAltoDireitoAv"> <label for="farolAltoDireitoAv">farol alto direito</label><br>
            <input type="checkbox" id="farolAltoEsquerdoAv"> <label for="farolAltoEsquerdoAv">farol alto esquerdo</label><br>
            
            <input type="checkbox" id="setaAnteriorDireitaAv"> <label for="setaAnteriorDireitaAv">seta anterior direita</label><br>
            <input type="checkbox" id="setaAnteriorEsquerdaAv"> <label for="setaAnteriorEsquerdaAv">seta anterior esquerda</label><br>

            <input type="checkbox" id="buzinaAv"> <label for="buzinaAv">buzina</label><br>
            
            <input type="checkbox" id="luzReAv"> <label for="luzReAv">luz de ré</label><br>
            
            <input type="checkbox" id="lanternaPosteriorDireitaAv"> <label for="lanternaPosteriorDireitaAv">lanterna posterior direita</label><br>
            <input type="checkbox" id="lanternaPosteriorEsquerdaAv"> <label for="lanternaPosteriorEsquerdaAv">lanterna posterior esquerda</label><br>

            <input type="checkbox" id="setaPosteriorDireitaAv"> <label for="setaPosteriorDireitaAv">seta posterior direita</label><br>
            <input type="checkbox" id="setaPosteriorEsquerdaAv"> <label for="setaPosteriorEsquerdaAv">seta posterior esquerda</label><br>
            
            <input type="checkbox" id="freioAv"> <label for="freioAv">freio</label><br>

            <input type="checkbox" id="pneumaticoAnteriorEsquerdoAv"> <label for="pneumaticoAnteriorEsquerdoAv">pneumáticos anterior esquerdo</label><br>
            <input type="checkbox" id="pneumaticoAnteriorDireitoAv"> <label for="pneumaticoAnteriorDireitoAv">pneumáticos anterior direito</label><br>
            <input type="checkbox" id="pneumaticoPosteriorDireitoAv"> <label for="pneumaticoPosteriorDireitoAv">pneumáticos posterior direito</label><br>
            <input type="checkbox" id="pneumaticoPosteriorEsquerdoAv"> <label for="pneumaticoPosteriorEsquerdoAv">pneumáticos posterior esquerdo</label><br>

            <input type="checkbox" id="direcaoAv"> <label for="direcaoAv">direção</label><br>
            <input type="checkbox" id="airbagsAv"> <label for="airbagsAv">airbags</label><br>

            <input type="checkbox" id="cintoMotoristaAv"> <label for="cintoMotoristaAv">cinto do motorista</label><br>
            <input type="checkbox" id="cintoPassageiroAv"> <label for="cintoPassageiroAv">cinto do passageiro</label><br>
            <input type="checkbox" id="cintoTraseiroEsquerdoAv"> <label for="cintoTraseiroEsquerdoAv">cinto traseiro esquerdo</label><br>
            <input type="checkbox" id="cintoTraseiroCentralAv"> <label for="cintoTraseiroCentralAv">cinto traseiro central</label><br>
            <input type="checkbox" id="cintoTraseiroDireitoAv"> <label for="cintoTraseiroDireitoAv">cinto traseiro direito</label><br>
        </div>
        <button onclick="finalizarTeste()" style="margin-top: 10px;">Finalizar</button>
    </div>

    <textarea id="testesVeic" placeholder="Testes veiculares" name="testesVeic" rows="5"></textarea>


    
    <button id='pegarFotos' onclick="pegaFotos()" style="padding: 10px 30px; font-size: 1.2em; margin: 5px 0; width: 100%;">Pegar Fotos</button>
    <button onclick="gerarDocx()" style="margin: 20px 0; padding: 10px 20px;">Gerar Documento Word</button>
    <script>
        function proximoAvariados() {
            document.getElementById('popupTeste').style.display = 'none';
            document.getElementById('popupAvariados').style.display = 'block';
        }

        function abrirPopupTeste() {
            document.getElementById('popupTeste').style.display = 'block';
        }

        function finalizarTeste() {
            document.getElementById('popupAvariados').style.display = 'none';
            // Verifica se algum checkbox está marcado em popupTeste e popupAvariados
            const checkboxesTeste = document.getElementById('popupTeste').querySelectorAll('input[type="checkbox"]:checked');
            const checkboxesAvariados = document.getElementById('popupAvariados').querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkboxesTeste.length === 0 && checkboxesAvariados.length === 0) {
                document.getElementById('testesVeic').value = 'Os seus sistemas de segurança para o tráfego (freio, direção e elétrico) se encontravam articulados e atuantes, quando dos exames.';
            }

        }

        function abrirPopupDano() {
            document.getElementById('popupTipoDano').style.display = 'block';
        }

        function proximoOrientacao() {
            document.getElementById('popupTipoDano').style.display = 'none';
            document.getElementById('popupOrientacao').style.display = 'block';
        }

        function proximoSituado() {
            document.getElementById('popupOrientacao').style.display = 'none';
            document.getElementById('popupSituado').style.display = 'block';
        }

        function finalizarDano() {
            document.getElementById('popupSituado').style.display = 'none';
            // Pegar todas as checkboxes marcadas
            let texto = '';
            
            // Tipo de dano
            const tipoDano = document.getElementById('popupTipoDano')
                                   .querySelectorAll('input[type="checkbox"]:checked');
            
            // Orientação
            const orientacao = document.getElementById('popupOrientacao')
                                     .querySelectorAll('input[type="checkbox"]:checked');
            
            // Situado
            const situado = document.getElementById('popupSituado')
                                  .querySelectorAll('input[type="checkbox"]:checked');

            // Montar o texto com as opções selecionadas
            for (let i = 0; i < tipoDano.length; i++){
                let comma =', ';
                if((tipoDano.length==2)&&i==0) comma = ' e ';
                //if((tipoDano.length==3)&&i==0) comma = ', ';
                if((tipoDano.length==3)&&i==1) comma = ' e ';
                texto += tipoDano[i].nextElementSibling.textContent + comma;
            }
            texto += 'orientado(s) ';

            orientacao.forEach(checkbox => {
                texto += checkbox.nextElementSibling.textContent + ', ';
            });
            texto += 'situado(s) '
            situado.forEach(checkbox => {
                texto += checkbox.nextElementSibling.textContent + ', ';
            });
            texto = texto.slice(0, -2)+ '.';
            
            // Desmarcar todas as checkboxes
            tipoDano.forEach(checkbox => checkbox.checked = false);
            orientacao.forEach(checkbox => checkbox.checked = false); 
            situado.forEach(checkbox => checkbox.checked = false);
            // Adicionar ao textarea

            document.getElementById('danosVeic').value = document.getElementById('danosVeic').value + texto + '\n';
        }

        // Carregar dados padrão do arquivo pref.csv
        window.onload = function() {
            const dadosBase = document.getElementById('dadosBase');
            dadosBase.value = 
`Perito: Leonardo Reis da Silva
Diretor: José Domingos Moreira das Eiras
Núcleo: Núcleo de Perícias Criminalísticas de Americana
Equipe:`;
        }

        function importarPref() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            
            input.onchange = function(e) {
                const arquivo = e.target.files[0];
                const leitor = new FileReader();
                
                leitor.onload = function(evento) {
                    const dadosBase = document.getElementById('dadosBase');
                    dadosBase.value = evento.target.result;
                };
                
                leitor.readAsText(arquivo);
            };
            
            input.click();
        }
        
        function salvarPref() {
            // Garantir que os dados estejam em UTF-8
            const encoder = new TextEncoder();
            const decoder = new TextDecoder('utf-8');
            const dadosUTF8 = encoder.encode(document.getElementById('dadosBase').value);
            const dadosVerificados = decoder.decode(dadosUTF8);
            const dadosBase = document.getElementById('dadosBase').value;
            const blob = new Blob([dadosBase], { type: 'text/txt' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pref.txt';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        let video = document.getElementById('camera');
        let canvas = document.getElementById('foto');
        
        let resultado = document.getElementById('resultado');
        let botaoCaptFoto = document.getElementById('captFoto');
        let botaoAbreFoto = document.getElementById('abrirFoto');

        // Iniciar câmera
        // Tentar iniciar com a câmera traseira primeiro
        navigator.mediaDevices.getUserMedia({
            video: {
            facingMode: { exact: "environment" }, //camera traseira;
            width: { min: 1280, ideal: 1920 },
            height: { min: 720, ideal: 1080 },
            zoom: true,
            advanced: [{
                exposureMode: "manual",
                focusMode: "continuous"
            }]
            }
        })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(erro => {
            console.error('Erro ao acessar câmera traseira:', erro);
            // Se falhar, tenta acessar qualquer câmera disponível
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(erroFallback => {
                    console.error('Erro ao acessar câmera:', erroFallback);
                    alert('Não foi possível acessar nenhuma câmera.');
                });
        });
        function abrirFoto() {
            // Criar input de arquivo oculto
            let input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                let file = e.target.files[0];
                if (file) {
                    let reader = new FileReader();
                    reader.onload = function(event) {
                        // Criar uma imagem temporária
                        let img = new Image();
                        img.onload = function() {
                            canvas.style.display = 'block';
                            video.style.display = 'none';
                            botaoCaptFoto.disabled = true;
                            botaoAbreFoto.disabled = true;

                            // Configurar dimensões do canvas
                            canvas.width = img.width;
                            canvas.height = img.height;
                            
                            // Desenhar imagem no canvas
                            let ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            // Melhorar a imagem para OCR
                            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            let data = imageData.data;

                            // Aumentar DPI para 300
                            let tempCanvas = document.createElement('canvas');
                            let scale = 300 / 96; // 96 é o DPI padrão
                            tempCanvas.width = canvas.width * scale;
                            tempCanvas.height = canvas.height * scale;
                            let tempCtx = tempCanvas.getContext('2d');
                            
                            // Configurar para melhor qualidade de redimensionamento
                            tempCtx.imageSmoothingEnabled = true;
                            tempCtx.imageSmoothingQuality = 'high';
                            
                            // Redimensionar a imagem
                            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                            
                            // Copiar de volta para o canvas original
                            canvas.width = tempCanvas.width;
                            canvas.height = tempCanvas.height;
                            ctx.drawImage(tempCanvas, 0, 0);
                            
                            // Atualizar o contexto e os dados da imagem
                            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            data = imageData.data;

                            // Converter para escala de cinza e aumentar contraste
                            for (let i = 0; i < data.length; i += 4) {
                                let r = data[i];
                                let g = data[i + 1];
                                let b = data[i + 2];
                                
                                // Converter para escala de cinza
                                let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                                
                                // Aumentar contraste
                                gray = gray < 128 ? gray * 0.8 : gray * 1.2;
                                
                                // Limitar valores entre 0 e 255
                                gray = Math.min(255, Math.max(0, gray));
                                
                                data[i] = data[i + 1] = data[i + 2] = gray;
                            }
                            
                            ctx.putImageData(imageData, 0, 0);
                            reconhecerTexto();
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();

        }

        function capturarFoto() {
            canvas.style.display = 'block';
            video.style.display = 'none';
            botaoCaptFoto.disabled = true;
            botaoAbreFoto.disabled = true;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            // Melhorar a imagem para OCR
            let ctx = canvas.getContext('2d');
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            

            // Aumentar DPI para 300
            let tempCanvas = document.createElement('canvas');
            let scale = 300 / 96; // 96 é o DPI padrão
            tempCanvas.width = canvas.width * scale;
            tempCanvas.height = canvas.height * scale;
            let tempCtx = tempCanvas.getContext('2d');
            
            // Configurar para melhor qualidade de redimensionamento
            tempCtx.imageSmoothingEnabled = true;
            tempCtx.imageSmoothingQuality = 'high';
            
            // Redimensionar a imagem
            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // Copiar de volta para o canvas original
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            
            // Atualizar o contexto e os dados da imagem
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            data = imageData.data;
            // Converter para escala de cinza e aumentar contraste
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // Converter para escala de cinza
                let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // Aumentar contraste
                gray = gray < 128 ? gray * 0.8 : gray * 1.2;
                
                // Limitar valores entre 0 e 255
                gray = Math.min(255, Math.max(0, gray));
                
                data[i] = gray;
                data[i + 1] = gray; 
                data[i + 2] = gray;
            }
            
            ctx.putImageData(imageData, 0, 0);

            reconhecerTexto();
        }

        function reconhecerTexto() {
            const resultado = document.getElementById('resultado');
            const areaTexto = document.getElementById('textoOCR');
            

            areaTexto.value = 'Processando...';

            Tesseract.recognize(
                canvas,
                'por', // Idioma português
                { logger: m => console.log(m) }
            ).then(({ data: { text } }) => {
                areaTexto.value = text;
                canvas.style.display = 'none';
                video.style.display = 'block';
                botaoCaptFoto.disabled = false;
                botaoAbreFoto.disabled = false;
            }).catch(erro => {
                console.error('Erro no reconhecimento:', erro);
                areaTexto.value = 'Erro no reconhecimento de texto.';
                canvas.style.display = 'none';
                video.style.display = 'block';
                botaoCaptFoto.disabled = false;
                botaoAbreFoto.disabled = false;
            });

        }
        function analisarTexto() {
            const texto = document.getElementById('textoOCR').value;
            const textoAnalisado = document.getElementById('textoAnalisado');
            
            let naturezaDoExame = '';
            let placa = '';
            let chassi = '';
            
            // Procurar Natureza do Exame
            const regexNatureza = /Natureza do Exame:?\s*([^\n]+)/i;
            const matchNatureza = texto.match(regexNatureza);
            if (matchNatureza) {

                naturezaDoExame = matchNatureza[1].trim();
                // Remove eventuais ':' da string
                naturezaDoExame = naturezaDoExame.replace(/:/g, '');
            }
            
            // Procurar Placa
            const regexPlaca = /placa:?\s*([A-Z0-9]{7})/i;
            const matchPlaca = texto.match(regexPlaca);
            if (matchPlaca) {
                placa = matchPlaca[1].trim();
            }
            
            // Procurar Chassi
            // Procurar Chassi com tolerância a erros e espaços
            const regexChassiFlexivel = /chassi:?\s*([A-Z0-9\s]{15,25})/i; 
            const matchChassiFlexivel = texto.match(regexChassiFlexivel);
            if (matchChassiFlexivel) {
                let chassiEncontrado = matchChassiFlexivel[1].trim();
                // Se o chassi encontrado não tiver exatamente 17 caracteres, tenta ajustar
                if (chassiEncontrado.length !== 17) {
                    // Remove caracteres especiais mantendo apenas letras, números e espaços
                    chassiEncontrado = chassiEncontrado.replace(/[^A-Z0-9\s]/gi, '');
                    // Remove espaços extras
                    chassiEncontrado = chassiEncontrado.replace(/\s+/g, ' ');
                    // Remove todos os espaços para normalizar
                    chassiEncontrado = chassiEncontrado.replace(/\s/g, '');
                    // Pega os primeiros 17 caracteres se tiver mais
                    if (chassiEncontrado.length > 17) {
                        chassiEncontrado = chassiEncontrado.substring(0, 17);
                    }
                }
                chassi = chassiEncontrado;
            }
            const regexChassi = /chassi:?\s*([A-Z0-9]{17})/i;
            const matchChassi = texto.match(regexChassi);
            if (matchChassi) {
                chassi = matchChassi[1].trim();
            }
            // Procurar Tipo
            
            let tipo = '';
            const regexTipo = /tipo:?\s*([^]*?)(?=\s*Ano|$)/i;
            const matchTipo = texto.match(regexTipo);
            if (matchTipo) {
                tipo = matchTipo[1].trim();
            }

            // Procurar Ano de Fabricação
            let anoFabricacao = '';
            const regexAnoFabricacao = /(?:ano(?:\s+de)?\s+fabrica[çc][aã]o|fab\/mod)[:.]?\s*(\d{4})/i;
            const matchAnoFabricacao = texto.match(regexAnoFabricacao);
            if (matchAnoFabricacao) {
                anoFabricacao = matchAnoFabricacao[1].trim();
            }
            
            
            // Procurar Marca até a palavra Combustível
            let marca = '';
            const regexMarca = /marca:?\s*([^]*?)(?=\s*Comb|$)/i;
            const matchMarca = texto.match(regexMarca);
            if (matchMarca) {
                marca = matchMarca[1].trim();
            }
            // Procurar Cor como palavra isolada

            let cor = '';
            const regexCorIsolada = /\b(?:cor|Cor)\b:?\s*([^\n]+)/i;
            const matchCorIsolada = texto.match(regexCorIsolada);
            if (matchCorIsolada) {
                // Pegar apenas a primeira palavra da cor
                cor = matchCorIsolada[1].trim().split(/\s+/)[0];
            // Converter cores no masculino para feminino
            const coresMasculino = {
                'branco': 'branca',
                'preto': 'preta', 
                'vermelho': 'vermelha',
                'amarelo': 'amarela',
                'azul': 'azul',
                'verde': 'verde',
                'marrom': 'marrom',
                'cinza': 'cinza',
                'prata': 'prata',
                'dourado': 'dourada',
                'laranja': 'laranja',
                'roxo': 'roxa',
                'bege': 'bege'
            };
            
            cor = cor.toLowerCase();
            if (coresMasculino[cor]) {
                cor = coresMasculino[cor];
            }
            }




            // Procurar Protocolo
            let protocolo = '';
            const regexProtocolo = /[Vv]\d{5}\/\d{2}/;
            const matchProtocolo = texto.match(regexProtocolo);
            if (matchProtocolo) {
                protocolo = matchProtocolo[0];
            }

            // Procurar BO/Boletim
            let bo = '';
            let boletim = '';
            
            // Procura no formato específico XX0000-0/0000
            const regexBoFormato = /[A-Z]{2}\d{4}-\d\/\d{4}/;
            const matchBoFormato = texto.match(regexBoFormato);
            
            // Procura genérica por BO ou Boletim
            const regexBo = /(?:BO|Boletim)[:\s]+([^\n]+)/i;
            const matchBo = texto.match(regexBo);
            
            if (matchBoFormato) {
                // Se encontrou no formato específico, usa este
                bo = matchBoFormato[0];
                boletim = bo;
            } else if (matchBo) {
                // Se encontrou no formato genérico, usa este
                bo = matchBo[1].trim();
                boletim = bo;
            }

            // Procurar nome do Delegado
            let delegado = '';
            const regexDelegado = /(?:Dr\.|Dra\.|Delegado|Delegada)[.\s]+([^,\n]+)/i;

            const matchDelegado = texto.search(regexDelegado);
                        
            if (matchDelegado!=-1) {

                // Procura um nome antes da posição do delegado
                const textoAntesDoMatch = texto.substring(0, matchDelegado);
                const linhas = textoAntesDoMatch.split('\n');
                const ultimaLinha = linhas[linhas.length - 1].trim();
                if (ultimaLinha=="") ultimaLinha = linhas[linhas.length - 2].trim();
                delegado = ultimaLinha;
            }
            // Procurar Delegacia
            let delegacia = '';
            //const regexDelegacia = /(?:\d{3}\s*[-]?\s*)?([^,\n]*Delegacia[^,\n]*)/i;
            const regexDelegacia = /Delegacia :?\s*([^\n]+)/i;
            const matchDelegacia = texto.match(regexDelegacia);
            
            if (matchDelegacia) {
                // Pega o grupo capturado que exclui os 3 dígitos iniciais
                delegacia = matchDelegacia[1].trim().slice(6);
                console.log(matchDelegacia);
            }
            // Montar texto de resultado

            const resultado = `Natureza do Exame: ${naturezaDoExame}
Tipo: ${tipo}
Placa: ${placa}
Chassi: ${chassi}
Ano de Fabricação: ${anoFabricacao}
Marca: ${marca}
Cor: ${cor}
Protocolo: ${protocolo}
BO: ${bo}
Delegacia:${delegacia}
Delegado:${delegado}`;

            textoAnalisado.value = resultado;
        }
        async function pegaFotos() {
            try {
                // Solicitar permissão para acessar arquivos
                // Criar input de arquivo para selecionar múltiplas fotos
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = 'image/*';
                
                input.onchange = async function(e) {
                    // Limpar fotos anteriores
                    const fotosAnteriores = document.querySelectorAll('.foto-importada');
                    fotosAnteriores.forEach(foto => foto.remove());

                    // Array para armazenar as fotos selecionadas
                    const fotos = [];

                    // Processar cada arquivo selecionado
                    for (const arquivo of e.target.files) {
                        const dataModificacao = arquivo.lastModified;
                        
                        // Adicionar ao array com data de modificação
                        fotos.push({
                            arquivo: arquivo,
                            data: dataModificacao
                        });
                    }

                    // Filtrar apenas fotos dos últimos 10 minutos
                    // const dezMinutosAtras = Date.now() - (10 * 60 * 1000);
                    // const fotosRecentes = fotos.filter(foto => foto.data >= dezMinutosAtras);

                    // Ordenar fotos por data de modificação (mais recentes primeiro)
                    fotos.sort((a, b) => b.data - a.data);

                    // Criar elementos de imagem para as fotos selecionadas
                    for (const foto of fotos) {
                        const url = URL.createObjectURL(foto.arquivo);
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'foto-importada';
                        img.style.maxWidth = '100%';
                        img.style.marginTop = '10px';
                        document.body.appendChild(img);
                    }
                };

                // Acionar o seletor de arquivos
                input.click();

            } catch (erro) {
                console.error('Erro ao acessar diretório:', erro);
                alert('Não foi possível acessar o diretório de fotos.');
            }
        }
        
    


        async function gerarDocx() {
            try {
                // Criar novo documento
                const doc = new docx.Document();

                // Obter texto do textarea
                const texto = document.getElementById('resultado').value;

                // Adicionar texto ao documento
                doc.addSection({
                    properties: {},
                    children: [
                        new docx.Paragraph({
                            children: [
                                new docx.TextRun(texto)
                            ],
                        })
                    ]
                });

                // Obter todas as imagens
                const imagens = document.querySelectorAll('.foto-importada');
                
                // Adicionar cada imagem ao documento
                for (const img of imagens) {
                    const response = await fetch(img.src);
                    const blob = await response.blob();
                    const arrayBuffer = await blob.arrayBuffer();

                    const imagemDocx = docx.Media.addImage(doc, arrayBuffer);
                    
                    doc.addSection({
                        children: [
                            new docx.Paragraph({
                                children: [
                                    new docx.ImageRun({
                                        data: arrayBuffer,
                                        transformation: {
                                            width: 500,
                                            height: 300
                                        }
                                    })
                                ]
                            })
                        ]
                    });
                }

                // Gerar e baixar o arquivo
                docx.Packer.toBlob(doc).then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'laudo.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                });

            } catch (erro) {
                console.error('Erro ao gerar documento:', erro);
                alert('Erro ao gerar documento Word');
            }
        }
   
    

    </script>

</body>
</html>
